<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrar - Minha Clínica Inteligente</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
    <link rel="stylesheet" href="assets/css/chat.css">
    <style>
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 420px;
            padding: 32px 28px;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .logo {
            width: 96px;
            height: 96px;
            border-radius: 16px;
            background: url('assets/img/andreia.png') center/cover no-repeat;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .title {
            text-align: center;
        }
        .title h1 { font-size: 22px; color: #333; }
        .title p { font-size: 14px; color: #666; }
        .tabs { display: flex; gap: 12px; width: 100%; }
        .tab-btn { flex:1; padding: 10px 12px; border-radius: 10px; border: 1px solid #e0e0e0; background:#fff; font-weight:600; cursor:pointer; }
        .tab-btn.active { background:#667eea; border-color:#667eea; color:#fff; }
        .form { width:100%; display:none; gap:10px; }
        .form.active{ display:flex; flex-direction:column; }
        .input { width:100%; padding:12px; border:1px solid #e0e0e0; border-radius:10px; }
        .submit { width:100%; padding:12px; border-radius:10px; border:0; background:#111827; color:#fff; font-weight:700; cursor:pointer; }
        .submit[disabled]{ opacity:.6; cursor:not-allowed; }
        .error { color:#b91c1c; font-size:12px; }
        .success { color:#065f46; font-size:12px; }
        .google-btn {
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #333;
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .google-btn:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .google-icon { width: 18px; height: 18px; }
        .divider {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #999;
            font-size: 12px;
        }
        .divider::before, .divider::after { content: ""; height: 1px; background: #e6e6e6; flex: 1; }
        .alt-link { color: #667eea; text-decoration: none; font-weight: 600; }
        .alt-link:hover { text-decoration: underline; }
        @media (max-width: 768px) {
            .login-container { width: 100%; margin: 0 10px; border-radius: 12px; }
        }
    </style>
    <script src="assets/js/config.js"></script>
</head>
<body>
    <div id="particles-bg"></div>

    <main class="login-container">
        <div class="logo" aria-label="Logo da clínica"></div>
        <div class="title">
            <h1>Entrar</h1>
            <p>Minha Clínica Inteligente</p>
        </div>

        <div class="tabs">
            <button id="tab-login" class="tab-btn active" type="button">Entrar</button>
            <button id="tab-register" class="tab-btn" type="button">Criar Conta</button>
        </div>

        <form id="loginForm" class="form active" autocomplete="on">
            <input class="input" id="loginEmail" type="email" placeholder="Email" required>
            <input class="input" id="loginPassword" type="password" placeholder="Senha (min 6)" minlength="6" required>
            <button class="submit" id="loginBtn" type="submit">Entrar</button>
            <div id="loginMsg" class="error" aria-live="polite"></div>
        </form>

        <form id="registerForm" class="form" autocomplete="on">
            <input class="input" id="regName" type="text" placeholder="Nome completo" required>
            <input class="input" id="regEmail" type="email" placeholder="Email" required>
            <input class="input" id="regPassword" type="password" placeholder="Senha (min 6)" minlength="6" required>
            <button class="submit" id="registerBtn" type="submit">Criar Conta</button>
            <div id="registerMsg" class="error" aria-live="polite"></div>
        </form>

        <div class="divider">ou</div>

        <button id="googleSignInBtn" class="google-btn" type="button">
            <svg class="google-icon" viewBox="0 0 533.5 544.3" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M533.5 278.4c0-18.5-1.5-37-4.7-54.9H272.1v103.9h146.9c-6.1 33.6-25.1 62-53.5 81v67h86.5c50.7-46.7 81.5-115.5 81.5-197z" fill="#4285F4"/>
                <path d="M272.1 544.3c73.7 0 135.6-24.4 180.8-66.1l-86.5-67c-24 16.1-54.7 25.6-94.3 25.6-72.4 0-133.8-48.9-155.8-114.6H27.5v71.6c45 89.5 137.4 150.5 244.6 150.5z" fill="#34A853"/>
                <path d="M116.3 322.2c-10.2-30.2-10.2-63.1 0-93.3v-71.6H27.5c-38.5 76.9-38.5 159.6 0 236.5l88.8-71.6z" fill="#FBBC05"/>
                <path d="M272.1 107.7c39.9-.6 78.4 14.7 107.9 42.7l80.4-80.4C406.9 24.7 342 0 272.1 0 164.9 0 72.5 61 27.5 150.5l88.8 71.6c21.9-65.7 83.4-114.7 155.8-114.4z" fill="#EA4335"/>
            </svg>
            Entrar com Google
        </button>

        <a class="alt-link" href="index.html">Voltar ao chat</a>
    </main>

    <script>
        function setLoading(btn, loading) {
            if (loading) { btn.setAttribute('disabled', 'disabled'); btn.textContent = 'Aguarde...'; }
            else { btn.removeAttribute('disabled'); btn.textContent = btn.id === 'loginBtn' ? 'Entrar' : 'Criar Conta'; }
        }

        function saveToken(token) {
            try { localStorage.setItem('app_token', token); } catch(e) {}
            try { if (window.CONFIG) window.CONFIG.AUTH_TOKEN = token; } catch(e) {}
        }

        // Tabs
        var tabLogin = document.getElementById('tab-login');
        var tabRegister = document.getElementById('tab-register');
        var loginForm = document.getElementById('loginForm');
        var registerForm = document.getElementById('registerForm');
        tabLogin.addEventListener('click', function(){
            tabLogin.classList.add('active'); tabRegister.classList.remove('active');
            loginForm.classList.add('active'); registerForm.classList.remove('active');
        });
        tabRegister.addEventListener('click', function(){
            tabRegister.classList.add('active'); tabLogin.classList.remove('active');
            registerForm.classList.add('active'); loginForm.classList.remove('active');
        });

        // Prefill token se existir
        try { var existing = localStorage.getItem('app_token'); if (existing) { if (window.CONFIG) window.CONFIG.AUTH_TOKEN = existing; } } catch(e) {}

        // Submit Login
        loginForm.addEventListener('submit', async function(e){
            e.preventDefault();
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            var msg = document.getElementById('loginMsg'); msg.textContent = '';
            if (!email || !password || password.length < 6) { msg.textContent = 'Preencha um email válido e senha (min 6).'; return; }
            setLoading(document.getElementById('loginBtn'), true);
            try {
                var res = await fetch((window.CONFIG.API_BASE || '') + '/auth/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, password: password })
                });
                var data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Falha no login');
                saveToken(data.token);
                // Decide destino conforme perfil admin
                try {
                    var me = await fetch((window.CONFIG.API_BASE || '') + '/auth/me', {
                        method: 'GET', credentials: 'include', headers: (window.CONFIG && window.CONFIG.AUTH_TOKEN) ? { 'Authorization': 'Bearer ' + window.CONFIG.AUTH_TOKEN } : {}
                    });
                    if (me.ok) {
                        var meData = await me.json();
                        var isAdmin = !!(meData && meData.user && (meData.user.is_admin === true || meData.user.is_admin === 1));
                        window.location.href = isAdmin ? 'panel.html#dashboard' : 'index.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } catch(e) { window.location.href = 'index.html'; }
            } catch(err) {
                msg.textContent = err.message || 'Erro ao autenticar';
            } finally { setLoading(document.getElementById('loginBtn'), false); }
        });

        // Submit Register
        registerForm.addEventListener('submit', async function(e){
            e.preventDefault();
            var name = document.getElementById('regName').value.trim();
            var email = document.getElementById('regEmail').value.trim();
            var password = document.getElementById('regPassword').value;
            var msg = document.getElementById('registerMsg'); msg.textContent='';
            if (!name || !email || !password || password.length < 6) { msg.textContent = 'Preencha nome, email e senha (min 6).'; return; }
            setLoading(document.getElementById('registerBtn'), true);
            try {
                var res = await fetch((window.CONFIG.API_BASE || '') + '/auth/register', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ full_name: name, email: email, password: password })
                });
                var data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Falha no cadastro');
                saveToken(data.token);
                // Decide destino conforme perfil admin
                try {
                    var me = await fetch((window.CONFIG.API_BASE || '') + '/auth/me', {
                        method: 'GET', credentials: 'include', headers: (window.CONFIG && window.CONFIG.AUTH_TOKEN) ? { 'Authorization': 'Bearer ' + window.CONFIG.AUTH_TOKEN } : {}
                    });
                    if (me.ok) {
                        var meData = await me.json();
                        var isAdmin = !!(meData && meData.user && (meData.user.is_admin === true || meData.user.is_admin === 1));
                        window.location.href = isAdmin ? 'panel.html#dashboard' : 'index.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } catch(e) { window.location.href = 'index.html'; }
            } catch(err) {
                msg.textContent = err.message || 'Erro ao cadastrar';
            } finally { setLoading(document.getElementById('registerBtn'), false); }
        });
        document.getElementById('googleSignInBtn').addEventListener('click', function() {
            if (!window.CONFIG || !window.CONFIG.API_BASE) {
                return;
            }
            window.location.href = window.CONFIG.API_BASE + '/auth/google/login';
        });
    </script>
</body>
</html>


